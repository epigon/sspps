{% extends 'base.html' %}

{% block title%}Users{% endblock %}
{% block head %}
{{super()}}
<!-- DataTables CSS -->
<link
    href="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.css"
    rel="stylesheet" integrity="sha384-Ds1Vklai96R25BXbTa08O+OjpAevmakmGFQNAQECNryYdQ0qbN4CJSMwUSFT+NYe"
    crossorigin="anonymous">

<!-- DataTables JS -->
<script
    src="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.js"
    integrity="sha384-lGlyEraPH4ouPKo2ethY8Xic4JlIXN/CUbMNpOce3EjRhLuGH732aMGDH7Cv8+VY"
    crossorigin="anonymous"></script>
{%block styles %}
{{super()}}
<style>
    #users-table_length {
        display: flex;
        align-items: center;
    }
</style>
{% endblock %}
{% endblock %}
{% block content %}
<div class="container my-2">
    <h2>Users</h2>

    <a href="{{ url_for('users.edit') }}" class="btn btn-primary mb-3">Create New User</a>

    <table class="table table-striped" id="users-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Username</th>
                <th>Role</th>
                <th>Last Modified</th>
                <th>Manage</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.employee.employee_name }}</td>
                <td>{{ user.username }}</td>
                <td>{{ user.role.name if user.role else 'None' }}</td>
                <td>{{ (user.modify_date if user.modify_date else user.create_date).strftime('%m/%d/%Y %I:%M %p') }}
                </td>
                <td>
                    <a href="{{ url_for('users.edit', user_id=user.id) }}">Edit</a> |
                    <a href="{{ url_for('users.delete', user_id=user.id) }}"
                        onclick="return confirm('Are you sure you want to delete the user \'{{ user.employee.employee_name }}\'? This action cannot be undone.')">
                        Delete
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const table = $('#users-table').DataTable({
        pageLength: 25,
        lengthMenu: [10, 25, 50, 100],
        order: [[0, 'asc']],
        // Disable sorting for the last column (Manage)
        columnDefs: [
            { orderable: false, targets: -1 } // -1 = last column
        ],
        
        // v2 DOM structure
        layout: {
            topStart: 'pageLength',
            topEnd: 'search',
        },
        initComplete: function () {
            // Build Role Filter HTML
            const roleFilterHtml = `
                <label class="ms-5 mb-0">
                    Role:
                    <select id="role-filter" class="form-select form-select-sm d-inline-block ms-1" style="width:auto;">
                        <option value="">All</option>
                        {% for role in roles %}
                        <option value="{{ role.name }}">{{ role.name }}</option>
                        {% endfor %}
                    </select>
                </label>
            `;

            // Find the v2 .dt-length container
            const lengthContainer = document.querySelector('.dt-length');
            if (lengthContainer) {
                lengthContainer.insertAdjacentHTML('beforeend', roleFilterHtml);
            } else {
                console.warn('Could not find .dt-length element');
            }

            // Hook up the filter
            document.addEventListener('change', (e) => {
                if (e.target && e.target.id === 'role-filter') {
                    const val = e.target.value;
                    table.column(2).search(val || '', true, false).draw();
                }
            });
        }
    });
});
</script>
{% endblock %}
