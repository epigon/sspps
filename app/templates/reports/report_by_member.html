{% extends "base.html" %}

{% block title%}
Dashboard
{% endblock %}

{% block head %}
{{super()}}
{% block styles %}
{{super()}}
<style>
    .cell-disabled {
        color: #aaa !important;
    }

    .cell-bold {
        font-weight: bold;
    }

    .commitment-cell {
        text-align: right;
        font-weight: 500;
        padding: 4px;
        color: #222;
    }

    .heatmap-legend span {
        color: #444;
    }

    .totals-row {
        background-color: #f5f5f5;
        font-weight: bold;
    }
</style>

{% endblock %}
<!-- Datatables -->
<link
    href="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.css"
    rel="stylesheet" integrity="sha384-Ds1Vklai96R25BXbTa08O+OjpAevmakmGFQNAQECNryYdQ0qbN4CJSMwUSFT+NYe"
    crossorigin="anonymous">
<script
    src="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.js"
    integrity="sha384-lGlyEraPH4ouPKo2ethY8Xic4JlIXN/CUbMNpOce3EjRhLuGH732aMGDH7Cv8+VY"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
{% endblock %}

{% block content %}
<!-- Main content -->
<div class="container-fluid">
    <div class="row">
        <div class="col">
            {% include "/reports/_filter_reports.html" %}
            <div class="heatmap-legend" style="display:flex;align-items:center;gap:8px;margin:10px 0;">
                <span>Commitment Legend:</span>
                <span style="font-size:0.85em;">0%</span>
                <div style="flex:1;height:16px;
                    background: linear-gradient(to right,
                    rgba(255,0,0,0.25) 0%,     /* red */
                    rgba(255,255,0,0.25) 50%,  /* yellow */
                    rgba(0,128,0,0.25) 100%    /* green */
                    );
                    border-radius:4px;">
                </div>
                <span style="font-size:0.85em;margin-left:auto;">100%</span>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Export Button with Spinner -->
    <button onclick="exportDetailToExcel()" class="btn btn-primary align-items-center gap-2 my-2">
        <span id="detail-text">Export Detail Report</span>
        <span id="detail-spinner" class="spinner-border spinner-border-sm d-none" role="status"
            aria-hidden="true"></span>
    </button>

    <button onclick="exportSummaryToExcel()" class="btn btn-primary align-items-center gap-2 my-2">
        <span id="summary-text">Export Summary Report</span>
        <span id="summary-spinner" class="spinner-border spinner-border-sm d-none" role="status"
            aria-hidden="true"></span>
    </button>

    <div id="tablesContainer" class="mt-3">
        <!-- Dynamically generated tables will go here -->
    </div>
</div>

<!-- End Main content -->
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function trimEmptyCells(arr) {
        // Remove leading and trailing empty strings
        let start = 0;
        while (start < arr.length && arr[start] === "") start++;

        let end = arr.length - 1;
        while (end >= 0 && arr[end] === "") end--;

        return arr.slice(start, end + 1);
    }

    async function exportDetailToExcel() {
        const btn = this;
        const text = document.getElementById("detail-text");
        const spinner = document.getElementById("detail-spinner");
        const workbook = new ExcelJS.Workbook();
        const tables = document.querySelectorAll("#tablesContainer table");

        // Disable button and show spinner
        btn.disabled = true;
        text.innerText = "Exporting...";
        spinner.classList.remove("d-none");

        const existingSheets = []

        for (const table of tables) {
            let currentRow = 1;

            // start with member name or default
            let sheetName = (table.dataset.memberName || "Sheet")
                .replace(/[^a-zA-Z0-9 ]/g, "")   // keep only alphanumeric and spaces
                .trim();

            // fallback if empty
            if (!sheetName) sheetName = "Sheet";

            // enforce max length 30
            if (sheetName.length > 30) {
                sheetName = sheetName.substring(0, 30);
            }

            // ensure uniqueness
            let uniqueName = sheetName;
            let counter = 2;
            while (existingSheets.includes(uniqueName)) {
                const suffix = ` (${counter})`;
                const maxLength = 30 - suffix.length;
                uniqueName = `${sheetName.substring(0, maxLength)}${suffix}`;
                counter++;
            }

            // track it
            existingSheets.push(uniqueName);

            // create worksheet
            const worksheet = workbook.addWorksheet(uniqueName);

            // Extract header
            const rawHeaders = Array.from(table.querySelectorAll("thead tr th")).map(th => th.innerText.trim());

            // Remove leading/trailing empty headers
            const headers = trimEmptyCells(rawHeaders);
            worksheet.addRow(headers);
            
            // Style header row
            const headerRow = worksheet.getRow(1);
            headerRow.eachCell((cell) => {
                cell.font = { bold: true, color: { argb: "FFFFFFFF" } };
                cell.fill = {
                    type: "pattern",
                    pattern: "solid",
                    fgColor: { argb: "FF00629B" } // Blue background (note the FF prefix for opacity)
                };
            });
            currentRow++;

            // Extract rows
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll("td"));
                const rowValues = cells.map(td => td.innerText.trim());
                const excelRow = worksheet.insertRow(currentRow, trimEmptyCells(rowValues));

                cells.forEach((td, idx) => {
                    const pct = parseFloat(td.getAttribute("data-pct"));
                    console.log(pct, isNaN(pct));
                    if (!isNaN(pct)) {
                        let fillColor = "FFFFFF"; // default white

                        // ðŸ”§ Muted heatmap (adjust thresholds/colors as you like)
                        if (pct >= 90) fillColor = "FFC6EFCE";   // green
                        else if (pct >= 50) fillColor = "FFFFEB9C"; // orange/yellow
                        else if (pct >= 0) fillColor = "FFF2DCDB";   // red/pink

                        excelRow.getCell(idx + 1).fill = {
                            type: "pattern",
                            pattern: "solid",
                            fgColor: { argb: fillColor }
                        };
                    }
                });
                currentRow++;
            });

            // Adjust column widths
            worksheet.columns.forEach((column, idx) => {
                const values = column.values.slice(1); // skip index 0
                const widths = values.map(v => (v ? v.toString().length : 10));
                const maxLength = Math.max(...widths) + 2;
                column.width = maxLength;
            });
        };

        // Only write and download once after all sheets are added
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "SSPPS_Committee_Members_Detail.xlsx";
        link.click();

        // Re-enable button and hide spinner
        btn.disabled = false;
        text.innerText = "Export Detail Report";
        spinner.classList.add("d-none");
    }

    async function exportSummaryToExcel() {
        const btn = this;
        const text = document.getElementById("summary-text");
        const spinner = document.getElementById("summary-spinner");
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("Committee Members");
        const tables = document.querySelectorAll("#tablesContainer table");

        // Disable button and show spinner
        btn.disabled = true;
        text.innerText = "Exporting...";
        spinner.classList.remove("d-none");

        let currentRow = 1;

        for (const table of tables) {
            const memberName = table.dataset.memberName || "Table";

            // Title row
            // worksheet.mergeCells(`A${currentRow}:Z${currentRow}`);
            const titleCell = worksheet.getCell(`A${currentRow}`);
            titleCell.value = memberName;
            titleCell.font = { bold: true, size: 14 };
            currentRow++;

            // Header row
            const rawHeaders = Array.from(table.querySelectorAll("thead tr th")).map(th => th.innerText.trim());
            const headers = trimEmptyCells(rawHeaders);
            worksheet.insertRow(currentRow, headers);

            // Style header
            const headerRow = worksheet.getRow(currentRow);
            headerRow.eachCell((cell) => {
                cell.font = { bold: true, color: { argb: "FFFFFFFF" } };
                cell.fill = {
                    type: "pattern",
                    pattern: "solid",
                    fgColor: { argb: "FF00629B" }
                };
            });

            currentRow++;

            // Data rows with heatmap coloring
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll("td"));
                const rowValues = cells.map(td => td.innerText.trim());
                const excelRow = worksheet.insertRow(currentRow, trimEmptyCells(rowValues));

                cells.forEach((td, idx) => {
                    const pct = parseFloat(td.getAttribute("data-pct"));
                    if (!isNaN(pct)) {
                        let fillColor = "FFFFFF"; // default white

                        // ðŸ”§ Muted heatmap (adjust thresholds/colors as you like)
                        if (pct >= 90) fillColor = "FFC6EFCE";   // green
                        else if (pct >= 50) fillColor = "FFFFEB9C"; // orange/yellow
                        else if (pct >= 0) fillColor = "FFF2DCDB";   // red/pink

                        excelRow.getCell(idx + 1).fill = {
                            type: "pattern",
                            pattern: "solid",
                            fgColor: { argb: fillColor }
                        };
                    }
                });

                currentRow++;
            });

            // Data rows
            // const rows = table.querySelectorAll("tbody tr");
            // rows.forEach(row => {
            //     const rowData = Array.from(row.querySelectorAll("td")).map(td => td.innerText.trim());
            //     worksheet.insertRow(currentRow, trimEmptyCells(rowData));
            //     currentRow++;
            // });

            // Add empty row between tables
            currentRow++;
        }

        // Adjust column widths
        worksheet.columns.forEach(column => {
            let maxLength = 10; // Default minimum width
            column.eachCell({ includeEmpty: true }, cell => {
                const cellValue = cell.value;
                if (cellValue !== null && cellValue !== undefined) {
                    const length = cellValue.toString().length;
                    if (length > maxLength) maxLength = length;
                }
            });
            column.width = maxLength + 2; // Add some padding
        });

        // Export workbook
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "SSPPS_Committee_Members_Summary.xlsx";
        link.click();

        // Re-enable button and hide spinner
        btn.disabled = false;
        text.innerText = "Export Summary Report";
        spinner.classList.add("d-none");
    }

    $(document).ready(function () {
        // Function to generate committee table
        function createCommitteeTable(member_data) {
            const dept = "SSPPS"
            member_data.forEach(member => {
                years = member.years;
                committees = member.committees;
                let tableId = member.employee_id;
                let colstyle = "col-" + Math.floor(12 / (years.length + 2)).toString()

                let tableHtml = `<h2>${member.first_name} ${member.last_name}</h2>
                        <table id="${tableId}" class="display table table-bordered table-sm academic-year-table" data-member-name="${member.first_name} ${member.last_name}">
                            <thead>
                                <th>${member.first_name} ${member.last_name} (${member.job_code})</th>`
                years.forEach(year => {
                    tableHtml += `<th class="${colstyle}">${year}</th>`
                })
                tableHtml += `
                            </thead>
                            <tbody>`
                committees.forEach(committee => {
                    let row = `<tr data-id="${committee.id}"><td>${committee.name} (${committee.short_name})</td>`;
                    years.forEach(year => {
                        const role = committee.roles[year] || '';
                        const s = (committee.stats && committee.stats[year]) || {};
                        const pct = s.percent_commitment ?? 0;   // already rounded to 2 decimals
                        const exp = s.total_expected_hours ?? 0;
                        const act = s.actual_hours ?? 0;
                        const att = s.meetings_attended ?? 0;
                        if (role == '') {
                            row += `<td class = "cell-disabled">-</td>`;
                        } else {
                            row += `<td data-pct="${pct}" style="background-color:${getHeatColor(pct)}">${role} (fulfilled ${act} of ${exp} hours)</td>`;
                        }

                    });
                    row += '</tr>';
                    tableHtml += row;
                })
                const totals = member.year_totals;
                tableHtml += `
                        <tr class="totals-row"><td>Totals:</td>`;

                for (const year of member.years) {
                    const annPct = totals[year]?.annual_percent_commitment || 0;
                    const annActual = totals[year]?.annual_actual_hours || 0;
                    const annExpected = totals[year]?.annual_expected_hours || 0;
                    tableHtml += `<td data-pct="${annPct}" class="${colstyle}" style="background-color:${getHeatColor(annPct)}">Fulfilled ${annActual.toFixed(2)} of ${annExpected.toFixed(2)} hrs</td>`;
                }
                tableHtml += `</tr>
                    `;
                // }
                tableHtml += `
                            </tbody>
                        </table>`;

                // Append the table HTML to the tables container
                $('#tablesContainer').append(tableHtml);
                // Initialize DataTable for this specific table
                let table = $(`#${tableId}`).DataTable(
                    {
                        searching: false, 
                        paging: false, 
                        info: false,
                        responsive: true
                    }
                );
            })
            $(".dt-button").removeClass("dt-button").addClass("btn btn-outline-primary");
        }

        let academicYear = $("#academic_year").val();
        let committee = $("#committee").val();
        let users = $("#users").val();
        let roles = $("#roles").val();
        let committeeTypes = $("#committee_type").val();

        // Fetch filtered data
        $.ajax({
            url: `/reports/get_committees_by_member?years=${academicYear}&committees=${committee}&users=${users}&roles=${roles}&types=${committeeTypes}`,
            method: 'GET',
            success: function (data) {
                // Clear any previous tables
                $('#tablesContainer').empty();
                createCommitteeTable(data);
            }
        });

        $("#reportForm").submit(function (event) {
            event.preventDefault();

            let academicYear = $("#academic_year").val();
            let committee = $("#committee").val();
            let users = $("#users").val();
            let roles = $("#roles").val();
            let committeeTypes = $("#committee_type").val();

            // Fetch filtered data
            $.ajax({
                url: `/reports/get_committees_by_member?years=${academicYear}&committees=${committee}&users=${users}&roles=${roles}&types=${committeeTypes}`,
                method: 'GET',
                success: function (data) {
                    // Clear any previous tables
                    $('#tablesContainer').empty();
                    createCommitteeTable(data);
                }
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const multiSelects = ["academic_year", "committee", "committee_type", "users"];

        multiSelects.forEach(id => {
            const select = document.getElementById(id);

            if (select) {
                select.addEventListener("change", function () {
                    const selectedOptions = Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
                    const allOption = select.querySelector('option[value="0"]');

                    // If "All" is selected and others are selected, deselect "All"
                    if (selectedOptions.includes(0) && selectedOptions.length > 1) {
                        allOption.selected = false;
                    }

                    // If no other options selected, reselect "All"
                    if (!selectedOptions.includes(0) && selectedOptions.length === 0) {
                        allOption.selected = true;
                    }
                });
            }
        });
    });

    function getHeatColor(value) {
        const v = Math.min(Math.max(value || 0, 0), 100); // clamp 0â€“100

        if (v <= 50) {
            // red (255,0,0) â†’ yellow (255,255,0)
            const g = Math.round((v / 50) * 255);
            return `rgb(255,${g},0,0.25)`;
        } else {
            // yellow (255,255,0) â†’ green (0,128,0)
            const ratio = (v - 50) / 50;
            const r = Math.round(255 * (1 - ratio));
            const g = Math.round(255 - (127 * ratio)); // goes from 255 â†’ 128
            return `rgb(${r},${g},0,0.25)`;
        }
    }
</script>
{% endblock %}