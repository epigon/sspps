{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <h2>Instrument Request Form</h2>
    <form method="POST">
        {{ form.hidden_tag() }}
        {% for field in form if field.name != 'submit' and field.name != 'csrf_token' %}
        <div class="row mb-3">
            {% if field.type == 'RadioField' %}
            <div class="col-3">{{ field.label(class="form-check-label") }}</div>
            <div class="col-6">{% for subfield in form.had_training %}
                <div class="form-check form-check-inline">
                    {{ subfield(class="form-check-input") }}
                    {{ subfield.label(class="form-check-label") }}
                </div>
                {% endfor %}
            </div>
            {% elif field.type == 'SelectField' or field.type == 'DataAttributeSelectField' %}
            <div class="col-3">{{ field.label(class="form-label") }}</div>
            <div class="col-6">{{ field(class="form-select") }}</div>
            {% else %}
            <div class="col-3">{{ field.label(class="form-label") }}</div>
            <div class="col-6">{{ field(class="form-control") }}</div>
            {% endif %}
            <div class="col-3">
                {% for error in field.errors %}
                <div class="text-danger small">{{ error }}</div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {{ form.submit(class="btn btn-primary") }}
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function () {
        const piSelect = document.getElementById('pi_name');
        const piEmail = document.getElementById('pi_email');
        const projectSelect = document.getElementById('project_task_code');
        const fundingSelect = document.getElementById('funding_source');

        // Store original options so we can restore them later
        const projectOptions = Array.from(projectSelect.options);
        const fundingOptions = Array.from(fundingSelect.options);

        // Step 1: Filter project_task_code by PI
        piSelect.addEventListener('change', function () {
            const selectedPI = this.options[this.selectedIndex];
            const email = selectedPI.dataset.email; // grab data-email
            piEmail.value = email || '';  // set the input field value

            projectSelect.innerHTML = ''; // clear
            projectOptions.forEach(opt => {
                if (!opt.value || !email || opt.dataset.email === email) {
                    projectSelect.appendChild(opt.cloneNode(true));
                }
            });

            // Reset funding source
            fundingSelect.innerHTML = '';
            fundingSelect.appendChild(fundingOptions[0].cloneNode(true)); // placeholder only

        });

        // Step 2: Filter funding_source by project_task_code
        projectSelect.addEventListener('change', function () {
            const selectedProject = this.value;
            fundingSelect.innerHTML = ''; // clear
            fundingOptions.forEach(opt => {
                if (!opt.value || !selectedProject || opt.dataset.projectTask === selectedProject) {
                    fundingSelect.appendChild(opt.cloneNode(true));
                }
            });
        });
    });
</script>
{% endblock %}