{% extends "base.html" %}

{% block title %}
Instrument Scheduler
{% endblock %}

{% block styles %}
{{ super() }}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<style>
    #calendar {
        max-width: 100%;
        margin: 20px auto;
    }

    #error {
        color: red;
        margin-top: 10px;
    }

    .fc-toolbar-title {
        font-weight: 600;
        font-size: 2rem;
    }

    .fc-toolbar-title::after {
        content: " ";
    }

    @keyframes pulse-danger {
        0% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, .6);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }

    .pulse {
        animation: pulse-danger 1.5s infinite;
    }

    .fc-event:not(.fc-event-draggable) {
    opacity: 0.6;
    cursor: not-allowed;
    }

</style>
{% endblock %}

{% block content %}

<div class="container">
    <div class="my-2 border border-1 p-2 rounded-3 bg-light">

        {% if request_id or admin %}
        <div class="row my-2 p-2">
            {% if request_id %}
            <div class="col">
                <h4 class="instruction-toggle" role="button">
                    <i class="icon-toggle bi bi-caret-right-fill"></i> General Instructions
                    <!-- <span class="ms-2 text-muted btn-toggle">+ Show</span> -->
                </h4>
                <ul class="instruction-list d-none">
                    <li>Click on a time slot to schedule an instrument</li>
                    <li>To edit booking, drag and drop the event to a new time slot or click and edit from the opened window, overlaps are not allowed</li>
                    <li>To delete a booking, click on the event and press the "Delete" button</li>
                    <li>For support, please email <a
                            href="mailto:sspps-dev@health.ucsd.edu">sspps-dev@health.ucsd.edu</a> with
                        information on PI name, requestor name, and booking details.</li>
                </ul>
            </div>
            {% endif %}

            {% if admin %}
            <div class="col">
                <h4 class="instruction-toggle" role="button">
                    <i class="icon-toggle bi bi-caret-right-fill"></i> Instructions for Admin
                    <!-- <span class="ms-2 text-muted btn-toggle">+ Show</span> -->
                </h4>
                <ul class="instruction-list d-none">
                    <li>Click on a time slot to schedule an instrument</li>
                    <li>To edit booking, drag and drop the event to a new time slot or click and edit from the opened
                        window.
                        <ul>
                            <li>If conflicts arise, the system will alert you to allow override.</li>
                        </ul>
                    </li>
                    <li>To delete a booking, click on the event and press the "Delete" button.</li>
                </ul>
            </div>
            {% endif %}

        </div>

        {% endif %}
        <div class="col my-2 p-2" id="filtersWrapper">
            <h4>Filter by Machine:</h4>
            <div id="machineFilters" class="d-flex gap-2">
                <!-- buttons go here -->
            </div>
        </div>
    </div>
</div>

<div id="calendar"></div>


<!-- Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Add Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                {% if admin and not request_id %}
                <div class="mb-2">
                    <label class="form-label fw-bold">Approved Request</label>
                    <select id="requestSelect" class="form-select">
                        <option value="">â€” Select Approved Request â€”</option>
                    </select>
                    <!-- hidden field that always mirrors the selected machine -->
                    <input type="hidden" id="selectedMachine" value="">
                </div>
                {% endif %}
                <div class="mb-2">
                    <label class="form-label fw-bold">Event Title</label>
                    <input type="text" id="eventTitle" class="form-control mb-2" readonly>
                </div>
                <div class="mb-2">
                    <label class="form-label fw-bold">Start Time</label>
                    <input type="datetime-local" id="eventStart" class="form-control mb-2">
                </div>
                <div class="mb-2">
                    <label class="form-label fw-bold">End Time</label>
                    <input type="datetime-local" id="eventEnd" class="form-control mb-2">
                </div>

                <div id="eventError" class="text-danger fw-bold"></div>

                {% if admin %}
                <div id="overrideSection" class="d-none mt-3 border-top pt-3 alert alert-warning">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="modalOverrideToggle">
                        <label class="form-check-label fw-bold text-danger">
                            Admin Override (ignore conflicts)
                        </label>
                    </div>
                    <div class="small text-muted">
                        This will force scheduling even if the machine is already booked.
                    </div>
                </div>
                {% endif %}

            </div>

            <div class="modal-footer">
                <button
                    id="deleteEventBtn"
                    class="btn btn-danger d-none"
                    data-admin="{{ 'true' if admin else 'false' }}"
                >
                    Delete
                </button>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="saveEventBtn" class="btn btn-primary">Save</button>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<!-- FullCalendar -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script src="https://www.google.com/recaptcha/api.js?render={{ recaptcha_site_key }}"></script>


{{ super() }}

<script>
document.addEventListener("DOMContentLoaded", function () {

    const requestID = {{ request_id| tojson}};
    const isAdmin = {{ admin| tojson }};
    const isPublic = {{ public| tojson }};
    const deleteBtn = document.getElementById("deleteEventBtn");
    const RECAPTCHA_SITE_KEY = "{{ recaptcha_site_key }}";

    let calendar;
    let selectedMachines = new Set();
    // let knownMachines = new Set();
    let allEvents = [];      // store ALL events once
    let machineColors = {}; // machine â†’ color map
    let request = null;

    // -----------------------------------------------------------
    // Permission helper â€“ true if the user may edit/delete this event
    // -----------------------------------------------------------
    function canEditEventByRequest(eventRequestId) {
        if (isAdmin) return true;
        if (!requestID || !eventRequestId) return false;

        return String(eventRequestId).trim() === String(requestID).trim();
    }


    // -----------------------------
    // REQUEST MODE: if requestID exists
    // -----------------------------
    if (requestID) {
        fetch(`/recharge/api/instrument-request/${requestID}`)
            .then(res => res.json())
            .then(req => {
                request = req;

                // Set event title in modal
                document.getElementById("eventTitle").value = req.machine_name + " - " + req.requestor_name;

                // Hide machine filters since only one machine is relevant
                document.getElementById("filtersWrapper").style.display = "none";

                // Only this machine is selected
                selectedMachines.clear();
                selectedMachines.add(req.machine_name);
                // Initialize calendar after setting selected machine
                fetchAllData().then(() => initCalendar());

            });
    }

    // -----------------------------
    // ADMIN / PUBLIC MODE: fetch all machines
    // -----------------------------
    else {
        // Fetch machines + colors for filter
        fetch("/recharge/api/machines")
            .then(res => res.json())
            .then(machines => {
                machines.forEach(m => selectedMachines.add(m));
                buildMachineLegend(machines); // pass color from server
                fetchAllData().then(() => initCalendar());
            });
    }

    // --------------------
    // Admin override UI
    // --------------------
    const overrideSection = document.getElementById("overrideSection");
    const modalOverride = document.getElementById("modalOverrideToggle");
    const saveBtn = document.getElementById("saveEventBtn");

    modalOverride?.addEventListener("change", () => {
        saveBtn.disabled = !modalOverride.checked;
    });


    document.getElementById("eventModal")?.addEventListener("shown.bs.modal", () => {
        const errorDiv = document.getElementById("eventError");
        if (errorDiv) errorDiv.textContent = "";

        resetOverrideUI(); // already safe after our fix
        // If NEW event and title is empty, apply default
        if (!saveBtn.dataset.eventId) {
            const titleInput = document.getElementById("eventTitle");
            if (!titleInput.value) {
                titleInput.value = getDefaultEventTitle();
            }
        }

        if (!saveBtn.dataset.eventId && deleteBtn) {
            deleteBtn.classList.add("d-none");
        }

    });


    ["eventStart", "eventEnd"].forEach(id => {
        document.getElementById(id)?.addEventListener("change", () => {
            document.getElementById("eventError").textContent = "";
        });
    });

    document.querySelectorAll(".instruction-toggle").forEach(header => {
        header.addEventListener("click", () => {
            const toggleIcon = header.querySelector(".icon-toggle");
            if (toggleIcon) {
                toggleIcon.classList.toggle("bi-caret-right-fill");
                toggleIcon.classList.toggle("bi-caret-down-fill");
            }
            const list = header.nextElementSibling;
            if (!list) return;

            list.classList.toggle("d-none");
        });
    });

   
    function fetchAllData() {
        return fetch("/recharge/api/events")
            .then(res => res.json())
            .then(data => {
                // -------------------------------------------------
                // Add a perâ€‘event `editable` property based on ownership
                // -------------------------------------------------
                allEvents = (data.events || []).map(ev => {
                    const eventRequestId = ev.extendedProps?.request_id ?? ev.request_id;

                    ev.startEditable = canEditEventByRequest(eventRequestId);

                    return ev;
                });

                data.machines.forEach(m => {
                    machineColors[m.name] = m.color;
                });

                buildMachineLegend(data.machines);
                // console.log("Fetched events and machines", allEvents, data.machines);
            });
    }

    function getDefaultEventTitle() {
        // Request-based scheduling
        if (request) {
            return `${request.machine_name} â€” ${request.requestor_name}`;
        }

        // Admin selecting approved request
        const select = document.getElementById("requestSelect");
        if (select && select.value) {
            const opt = select.selectedOptions[0];
            return `${opt.dataset.machine} â€” ${opt.dataset.requestor}`;
        }

        return "";
    }


    function getOverrideEls() {
        return {
            section: document.getElementById("overrideSection"),
            toggle: document.getElementById("modalOverrideToggle"),
            save: document.getElementById("saveEventBtn")
        };
    }

    function showOverrideUI() {
        if (!isAdmin) return;

        const { section, toggle, save } = getOverrideEls();
        if (!section || !toggle || !save) return;

        section.classList.remove("d-none");
        toggle.classList.add("pulse");
        save.disabled = true;
    }

    function resetOverrideUI() {
        if (!isAdmin) return;

        const { section, toggle, save } = getOverrideEls();
        if (!section || !toggle || !save) return;

        section.classList.add("d-none");
        toggle.checked = false;
        toggle.classList.remove("pulse");
        save.disabled = false;
    }


    // Minimal MD5 function for color hashing
    function md5(str) {
        // Use a simple JS hash function for consistency
        // For production, include a proper MD5 library
        return CryptoJS.MD5(str).toString();
    }

    function buildMachineLegend(machines) {
        const container = document.getElementById("machineFilters");
        machines.forEach(m => {
            if (!m.name) return;
            
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "btn me-1 mb-1";
            btn.style.backgroundColor = m.color; // use server color
            btn.style.color = "#fff";
            btn.textContent = m.name;
            btn.dataset.active = "true";

            btn.addEventListener("click", () => {
                const active = btn.dataset.active === "true";
                btn.dataset.active = (!active).toString();
                btn.style.opacity = active ? "0.5" : "1";

                active ? selectedMachines.delete(m.name) : selectedMachines.add(m.name);
                calendar.refetchEvents();
            });

            container.appendChild(btn);
        });
    }


    function isValidDateRange(startStr, endStr) {
        if (!startStr || !endStr) return false;

        const start = new Date(startStr);
        const end = new Date(endStr);

        return end > start;
    }


    function enableMachineFilter(machineName) {
        selectedMachines.add(machineName);

        const buttons = document.querySelectorAll("#machineFilters button");
        buttons.forEach(btn => {
            if (btn.textContent === machineName) {
                btn.dataset.active = "true";
                btn.style.opacity = "1";
            }
        });
    }


    // --------------------
    // Admin Approved Request dropdown
    // --------------------
    if (isAdmin) {
        fetch("/recharge/api/approved-requests")
            .then(res => res.json())
            .then(requests => {
                const select = document.getElementById("requestSelect");
                if (!select) return;

                requests.forEach(r => {
                    const opt = document.createElement("option");
                    opt.value = r.id;
                    opt.dataset.machine = r.machine_name;
                    opt.dataset.requestor = r.requestor_name;
                    opt.textContent = `${r.machine_name} â€” ${r.requestor_name}`;
                    select.appendChild(opt);
                });

                select.addEventListener("change", function () {
                    const option = this.selectedOptions[0];
                    if (!option) return;

                    document.getElementById("eventTitle").value = option.textContent;
                    this.dataset.machine = option.dataset.machine;
                    this.dataset.requestor = option.dataset.requestor;
                });
            });
    }


    // --------------------
    // Initialize calendar
    // --------------------
    function initCalendar() {
        calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
            initialView: "timeGridWeek",


            headerToolbar: {
                left: "prev,next today",
                center: "title",
                right: "timeGridDay,timeGridWeek"
            },

            selectable: isAdmin || Boolean(requestID && request && request.status === "Approved"),
            editable: isAdmin,

            events: function (fetchInfo, success) {
                const filtered = allEvents.filter(e =>
                    selectedMachines.has(e.extendedProps.machine_name)
                );
                success(filtered);
                
            },
            // Allow a drag only when the user owns the request
            eventAllow: function (dropInfo, draggedEvent) {
                return (
                    isAdmin ||
                    Boolean(requestID &&
                    draggedEvent.extendedProps.request_id === requestID)
                );
            },


            datesSet: function () {
                if (isAdmin && !request) return;

                if (isPublic) {
                    const titleEl = document.querySelector(".fc-toolbar-title");
                    if (titleEl) {
                        titleEl.textContent = "Instruments Calendar";
                    }
                    return
                }

                let titleText = "Scheduler";

                // Request mode
                if (request?.machine_name) {
                    titleText = `${request.machine_name} Scheduler`;
                }
                // Single machine selected
                else if (selectedMachines.size === 1) {
                    titleText = `${[...selectedMachines][0]} Scheduler`;
                }

                const titleEl = document.querySelector(".fc-toolbar-title");
                if (titleEl) {
                    titleEl.textContent = titleText;
                }
            },

            select: function (info) {
                if (isPublic) return;

                // RESET ADMIN MODAL STATE
                resetEventModalForNew();

                document.getElementById("eventStart").value = info.startStr.slice(0, 16);
                document.getElementById("eventEnd").value = info.endStr.slice(0, 16);

                bootstrap.Modal
                    .getOrCreateInstance(document.getElementById("eventModal"))
                    .show();
            },
            eventClick: function (info) {

                updateDeleteButton(info.event);

                const e = info.event;
                const props = e.extendedProps;

                // Permission check â€“ allow edit/delete for admins OR
                // for the exact request_id that appears in the URL
                const canEdit = e.startEditable;

                if (canEdit === false) {
                    // nonâ€‘editable event â†’ just stop navigation & exit
                    info.jsEvent.preventDefault();
                    return;
                }

                // Pull from extendedProps
                const machineName = props.machine_name;
                const requestId = props.request_id;
                const requestorName = props.requestor_name || "";

                // Populate the modal â€“ same UI used for admins, but without override
                const requestSelect = document.getElementById("requestSelect");
                
                if (requestSelect) {
                    requestSelect.value = requestId || "";
                    requestSelect.addEventListener("change", function () {
                        const option = this.selectedOptions[0];
                        if (!option) return;

                        // Update the title input (existing behaviour)
                        document.getElementById("eventTitle").value = option.textContent;

                        // Store machine & requestor on the select element (existing behaviour)
                        this.dataset.machine = option.dataset.machine;
                        this.dataset.requestor = option.dataset.requestor;

                        // ---- NEW: keep a hidden field in sync ----
                        const hiddenMachine = document.getElementById("selectedMachine");
                        if (hiddenMachine) {
                            hiddenMachine.value = option.dataset.machine || "";
                        }
                    });
                }

                // Prefill modal with event info
                const titleInput = document.getElementById("eventTitle");
                titleInput.value =
                    e.title ||
                    (machineName && requestorName
                        ? `${machineName} â€” ${requestorName}`
                        : "");

                document.getElementById("eventStart").value = e.startStr.slice(0, 16);
                document.getElementById("eventEnd").value = e.endStr.slice(0, 16);

                // If admin, enable override section if necessary
                resetOverrideUI();

                // Store event ID on modal save button for editing
                saveBtn.dataset.eventId = e.id;

                // Show Delete button only when the user may delete
                if (deleteBtn) {
                    if (canEdit) {
                        deleteBtn.classList.remove("d-none");
                        deleteBtn.dataset.eventId = e.id;
                    } else {
                        deleteBtn.classList.add("d-none");
                    }
                }

                bootstrap.Modal.getOrCreateInstance(document.getElementById("eventModal")).show();
            },

            eventDidMount: function (info) {
                const canEdit = info.event.startEditable;
                console.log("Event clicked:", info.event.title, info.event.id, "Editable:", canEdit, info.event.extendedProps);
                if (canEdit === false) {
                    // Visual lock
                    info.el.classList.add("fc-event-locked");
                    info.el.style.cursor = "not-allowed";

                    // Tooltip text
                    const reason = isAdmin
                        ? "This booking is locked"
                        : "This booking belongs to another request";

                    info.el.setAttribute("title", reason);

                    // Hover effects
                    info.el.addEventListener("mouseenter", () => {
                        info.el.classList.add("fc-event-locked-hover");
                    });

                    info.el.addEventListener("mouseleave", () => {
                        info.el.classList.remove("fc-event-locked-hover");
                    });

                    const lock = document.createElement("span");
                    lock.textContent = " ðŸ”’";
                    lock.style.fontSize = "0.85em";
                    lock.style.marginLeft = "4px";

                    const titleEl = info.el.querySelector(".fc-event-title");
                    if (titleEl) titleEl.appendChild(lock);

                } else {
                    info.el.style.cursor = "move";
                    info.el.classList.remove("fc-event-locked");
                    info.el.classList.remove("fc-event-locked-hover");
                    info.el.style.cursor = "pointer";
                }

                // Keep your existing machine color logic
                const machine = info.event.extendedProps.machine_name;
                info.el.style.backgroundColor = machineColors[machine] || "#747678";
            },
            eventDrop: handleEventMove,
            eventResize: handleEventMove
        });

        calendar.render();

    }

    function updateDeleteButton(event) {
        const btn = document.getElementById("deleteEventBtn");
        const isAdmin = btn.dataset.admin === "true";

        const eventReqId = event.extendedProps?.request_id;
        const pageReqId  = requestID; // from URL

        if (isAdmin || Boolean(eventReqId === pageReqId)) {
            btn.classList.remove("d-none");
        } else {
            btn.classList.add("d-none");
        }
    }

    function handleEventMove(info) {
        // Permission has already been checked by eventAllow,
        // so we can go straight to the server call.
        attemptMove(info, false);
    }

    function attemptMove(info, override) {
        // Execute reCAPTCHA v3
        grecaptcha.ready(function () {
            grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: "submit" }).then(function (token) {

                // Add token to payload
                const payload = {
                    id: info.event.id,
                    title: info.event.title,
                    start: info.event.start.toISOString(),
                    end: info.event.end.toISOString(),
                    machine_name: info.event.extendedProps?.machine_name,
                    request_id: info.event.extendedProps?.request_id || null,
                    override: override,
                    recaptcha_token: token
                };

                fetch("/recharge/api/events/update", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(res => res.json().then(d => ({ ok: res.ok, body: d })))
                    .then(res => {
                        // Conflict detected
                        if (!res.ok && res.body.conflict) {

                            // If override already approved, donâ€™t ask again
                            if (info.event.extendedProps._overrideApproved) {
                                return;
                            }

                            // Non-admins canâ€™t override
                            if (!isAdmin) {
                                alert(res.body.error);
                                info.revert();
                                return;
                            }

                            // Ask admin to confirm override
                            const confirmed = confirm(
                                "This move conflicts with an existing booking.\n\nOverride and force the move?"
                            );

                            if (confirmed) {
                                // mark event so we don't re-confirm
                                info.event.setExtendedProp("_overrideApproved", true);
                                // Retry WITH override
                                attemptMove(info, true);
                            } else {
                                info.revert();
                            }
                            return;
                        }

                        // Other error
                        if (!res.ok) {
                            alert(res.body.error || "Unable to move event.");
                            info.revert();
                        }
                    })
                    .catch(() => {
                        alert("Unexpected error while moving event.");
                        info.revert();
                    });
            });
        });
    }


    function resetEventModalForNew() {
        // Clear edit state
        delete saveBtn.dataset.eventId;

        // Reset request selector
        const requestSelect = document.getElementById("requestSelect");
        
        if (requestSelect) {
            requestSelect.value = "";
            delete requestSelect.dataset.machine;
            delete requestSelect.dataset.requestor;
        }

        // Clear title
        const titleInput = document.getElementById("eventTitle");
        if (titleInput) {
            titleInput.value = "";
        }

        // Hide delete button
        if (deleteBtn) {
            deleteBtn.classList.add("d-none");
            deleteBtn.removeAttribute("data-event-id");
        }

        // Reset override UI
        resetOverrideUI();

        // Clear any previous errors
        const errorDiv = document.getElementById("eventError");
        if (errorDiv) errorDiv.textContent = "";
    }


    // --------------------
    // Save Event
    // --------------------
    saveBtn.addEventListener("click", function () {
        const reqSelect = document.getElementById("requestSelect");
        const hiddenMachine = document.getElementById("selectedMachine");

        // New source for machine name
        const machineName = request?.machine_name ||
                            hiddenMachine?.value ||
                            reqSelect?.selectedOptions[0]?.dataset.machine ||
                            null;

        const requestorName = request?.requestor_name ||
                            reqSelect?.selectedOptions[0]?.dataset.requestor ||
                            null;

        const startVal = document.getElementById("eventStart").value;
        const endVal = document.getElementById("eventEnd").value;

        if (!isValidDateRange(startVal, endVal)) {
            document.getElementById("eventError").textContent =
                "End time must be later than start time.";
            return;
        }

        // Execute reCAPTCHA v3
        grecaptcha.ready(function () {
            grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: "submit" }).then(function (token) {

                const reqSelect = document.getElementById("requestSelect");
                const requestId = reqSelect?.value || requestID || null;
                const machineName = request?.machine_name || reqSelect?.selectedOptions[0]?.dataset.machine;
                const requestorName = request?.requestor_name || reqSelect?.selectedOptions[0]?.dataset.requestor;
                const override = isAdmin && modalOverride?.checked;

                if (override) {
                    const confirmed = confirm("You are overriding an existing booking.\n\nDo you want to continue?");
                    if (!confirmed) return;
                }

                const eventId = saveBtn.dataset.eventId || null; // âœ… check if editing
                const eventTitle = document.getElementById("eventTitle").value || machineName && requestorName ? `${machineName} â€” ${requestorName}` : ""; // âœ… check if editing

                // Add token to payload
                const payload = {
                    id: eventId,
                    title: eventTitle,
                    start: startVal,
                    end: endVal,
                    machine_name: machineName,
                    request_id: requestId,
                    override: override,
                    recaptcha_token: token  // âœ… send token to backend
                };
                fetch(payload.id ? "/recharge/api/events/update" : "/recharge/api/events", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            document.getElementById("eventError").textContent = data.error;
                            if (data.conflict) showOverrideUI();
                            return;
                        }

                        if (eventId) {

                            const canEdit = canEditEventByRequest(data.extendedProps.request_id);
                            // Update master list
                            const idx = allEvents.findIndex(e => e.id == eventId);
                            if (idx !== -1) {
                                // Update master list
                                allEvents[idx].title = data.title;
                                allEvents[idx].start = data.start;
                                allEvents[idx].end   = data.end;
                                allEvents[idx].startEditable = canEdit;
                            }

                            // Update visible event in FullCalendar
                            const event = calendar.getEventById(eventId);
                            event.setProp("title", data.title);
                            event.setStart(data.start);
                            event.setEnd(data.end);
                            event.setProp("startEditable", canEdit);
                            event.setProp("backgroundColor", data.backgroundColor);
                            event.setProp("borderColor", data.backgroundColor);

                        } else {
                            // NEW EVENT
                            const canEdit = canEditEventByRequest(data.extendedProps.request_id);

                            const newEvent = {
                                id: data.id,
                                title: data.title,
                                start: data.start,
                                end: data.end,
                                startEditable: canEdit,
                                backgroundColor: data.backgroundColor,
                                borderColor: data.backgroundColor,
                                extendedProps:  
                                {
                                    machine_name: data.extendedProps.machine_name,
                                    request_id: data.extendedProps.request_id,
                                    requestor_name: data.extendedProps.requestor_name
                                }
                            };

                            calendar.addEvent(newEvent);

                            // Enable its machine filter
                            enableMachineFilter(newEvent.extendedProps.machine_name);

                        }

                        resetOverrideUI();
                        delete saveBtn.dataset.eventId; // clear edit state
                        bootstrap.Modal.getInstance(document.getElementById("eventModal")).hide();

                    });
            });
        });
    });

    // Delete Event
    deleteBtn?.addEventListener("click", function () {
        const eventId = this.dataset.eventId;
        if (!eventId) return;

        // Verify permission again (defensive)
        const eventObj = calendar.getEventById(eventId);
        const requestId = eventObj?.extendedProps?.request_id;
        
        if (!eventObj) return;
        if (!canEditEventByRequest(requestId)) {
            alert("You are not authorized to delete this booking.");
            return;
        }
        
        if (!confirm("Are you sure you want to delete this booking?")) return;

        grecaptcha.ready(function () {
            grecaptcha.execute(
                RECAPTCHA_SITE_KEY,
                { action: "submit" }
            ).then(function (token) {

                const payload = {
                    id: eventId,
                    request_id: requestId,   
                    recaptcha_token: token
                };

                fetch("/recharge/api/events/delete", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        // Remove from calendar
                        const event = calendar.getEventById(eventId);
                        if (event) event.remove();

                        // Also purge from the inâ€‘memory `allEvents` array
                        const idx = allEvents.findIndex(e => e.id == eventId);
                        if (idx !== -1) allEvents.splice(idx, 1);

                        bootstrap.Modal
                            .getInstance(document.getElementById("eventModal"))
                            .hide();
                    });
            });
        });
    });
});
</script>

{% endblock %}