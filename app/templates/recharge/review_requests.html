{% extends "base.html" %}

{% block head %}
{{ super() }}

<!-- DataTables CSS -->
<link
    href="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.css"
    rel="stylesheet" integrity="sha384-Ds1Vklai96R25BXbTa08O+OjpAevmakmGFQNAQECNryYdQ0qbN4CJSMwUSFT+NYe"
    crossorigin="anonymous">

<!-- DataTables JS -->
<script
    src="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.js"
    integrity="sha384-lGlyEraPH4ouPKo2ethY8Xic4JlIXN/CUbMNpOce3EjRhLuGH732aMGDH7Cv8+VY"
    crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>Instrument Requests</h2>

    <!-- Filter Form -->
    <form method="get" class="d-flex align-items-center mb-3">
        <label for="status" class="me-2 mb-0">Status:</label>
        <select name="status" id="status" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
            <option value="">All</option>
            <option value="Pending" {{ 'selected' if request.args.get('status')=='Pending' else '' }}>Pending</option>
            <option value="Approved" {{ 'selected' if request.args.get('status')=='Approved' else '' }}>Approved
            </option>
            <option value="Cancelled" {{ 'selected' if request.args.get('status')=='Cancelled' else '' }}>Cancelled
            </option>
            <option value="Denied" {{ 'selected' if request.args.get('status')=='Denied' else '' }}>Denied</option>
        </select>

        <label for="machine" class="ms-2 me-2 mb-0">Instrument:</label>
        <select name="machine" id="machine" class="form-select form-select-sm w-auto" onchange="this.form.submit()">
            <option value="">All</option>
            {% for m in machines %}
            <option value="{{ m.machine_name }}" {{ 'selected' if request.args.get('machine')==m.machine_name|string
                else '' }}>{{ m.machine_name }}</option>
            {% endfor %}
        </select>
    </form>

    <table id="requestTable" class="table table-bordered table-sm table-responsive table-striped">
        <thead>
            <tr>
                <th></th>
                <th>Request #</th>
                <th>Instrument</th>
                <th>PI Information</th>
                <th>Requestor Information</th>
                <th>Training Completed</th>
                <th>Project / Task Code</th>
                <th>Funding Source</th>
                <th>Submitted On</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requests %}
            <tr>
                <td class="dt-control"></td>
                <td>{{ req.id }}</td>
                <td>{{ req.machine_name }}</td>
                {% set pi = [] %}
                {% if req.pi_name %}
                {% set _ = pi.append(req.pi_name) %}
                {% endif %}
                {% if req.pi_email %}
                {% set _ = pi.append(req.pi_email) %}
                {% endif %}
                {% if req.pi_phone %}
                {% set _ = pi.append(req.pi_phone) %}
                {% endif %}
                {% if req.department %}
                {% set _ = pi.append(req.department.code+" - "+req.department.name) %}
                {% endif %}
                <td>{{ pi | join('<br />') | safe }}</td>
                {% set requestor = [] %}
                {% if req.requestor_name %}
                {% set _ = requestor.append(req.requestor_name) %}
                {% endif %}
                {% if req.requestor_position %}
                {% set _ = requestor.append(req.requestor_position) %}
                {% endif %}
                {% if req.requestor_email %}
                {% set _ = requestor.append(req.requestor_email) %}
                {% endif %}
                {% if req.requestor_phone %}
                {% set _ = requestor.append(req.requestor_phone) %}
                {% endif %}
                <td>{{ requestor | join('<br />') | safe }}</td>
                <td>{{ 'Yes' if req.had_training else 'No' }}</td>
                <td>{{ req.project_task_code }}</td>
                <td>{{ req.funding_source_code }}</td>
                <td>{{ req.created_at.strftime('%m/%d/%Y %I:%M %p').lower() if req.created_at else '' }}</td>
                <td>
                    <strong>{{ req.status }}</strong>
                    {% if req.status == 'Approved' or req.status == 'Denied' %}<br />
                    by {{ req.approver.employee_name or '' }}<br />
                    on {{ req.approved_at.strftime('%m/%d/%Y %I:%M %p').lower() if
                    req.approved_at else ''
                    }}
                    {% if req.notes %}
                    <div class="mt-1">
                        <strong>Notes:</strong><br>
                        <span class="text-muted">{{ req.notes }}</span>
                    </div>
                    {% endif %}
                    {% endif %}
                    {% if req.status == 'Approved' %}
                    <br /><a href="{{ url_for('recharge.resend_email', request_id=req.id) }}"
                        class="btn btn-secondary btn-sm">
                        Resend Email
                    </a>
                    {% endif %}
                </td>
                <td>
                    {% if req.status == 'Pending' %}
                    <form action="{{ url_for('recharge.handle_request', request_id=req.id) }}" method="post"
                        class="d-flex flex-column">
                        <textarea name="notes" class="form-control form-control-sm mb-1" rows="2"
                            placeholder="Enter notes..."></textarea>
                        <div class="btn-group">
                            <button type="submit" name="action" value="approve" class="btn btn-success btn-sm">
                                Approve
                            </button>
                            <button type="submit" name="action" value="deny" class="btn btn-danger btn-sm">
                                Deny
                            </button>
                        </div>
                    </form>
                    {% elif req.status == 'Approved' %}

                    <form action="{{ url_for('recharge.handle_request', request_id=req.id) }}" method="post"
                        class="d-flexx flex-columnx">
                        <textarea name="notes" class="form-control form-control-sm mb-1" rows="2"
                            placeholder="Enter notes..."></textarea>
                        <button type="submit" name="action" value="deny" class="btn btn-danger btn-sm">
                            Revoke Approval
                        </button>
                    </form>
                    {% else %}
                    <span class="text-muted">â€”</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function () {
    // Initialize DataTable
        let table = $('#requestTable').DataTable({
        lengthMenu: [10, 25, 50, { label: 'All', value: -1 }],
        pageLength: 10,
        responsive: true,
        order: [[8, 'asc']],
        columnDefs: [{ orderable: false, targets: 0 }],
        });
    });
</script>
{% endblock %}