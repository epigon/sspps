{% extends "base.html" %}
{% from 'bootstrap5/form.html' import render_form, render_field %}
{% from 'bootstrap5/utils.html' import render_messages %}

{% block title%}
Dashboard
{% endblock %}

{% block head %}
{{super()}}
{% block styles %}
{{super()}}
<link rel="stylesheet" href="{{ url_for('static', filename='css/committee-files.css') }}">
<style>
    :root {
        --brand: #0f3d5e;
        /* Primary brand color */
        --brand-2: #0a7aa6;
        /* Accent */
        --neutral: #f6f8fb;
        /* Background tint */
    }

    body {
        background-color: var(--neutral);
    }

    .hero {
        background:
        /*linear-gradient(90deg, rgba(15, 61, 94, .25), rgba(10, 122, 166, .1)),*/
        url("{{ url_for('static', filename='img/default-2024.jpg') }}");
        background-size: cover;
        background-position: center;
        color: #fff;
    }

    .section-card {
        border: 0;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, .06);
    }

    .badge {
        font-weight: normal !important;
    }
</style>
{% endblock %}
<!-- Datatables -->
<link
    href="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.css"
    rel="stylesheet" integrity="sha384-Ds1Vklai96R25BXbTa08O+OjpAevmakmGFQNAQECNryYdQ0qbN4CJSMwUSFT+NYe"
    crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"
    integrity="sha384-VFQrHzqBh5qiJIU0uGU5CIW3+OWpdGGJM9LBnGbuIH2mkICcFZ7lPd/AAtI7SNf7"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"
    integrity="sha384-/RlQG9uf0M2vcTw3CX7fbqgbj/h8wKxw7C3zu9/GxcBPRKOEcESxaxufwRXqzq6n"
    crossorigin="anonymous"></script>
<script
    src="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.js"
    integrity="sha384-lGlyEraPH4ouPKo2ethY8Xic4JlIXN/CUbMNpOce3EjRhLuGH732aMGDH7Cv8+VY"
    crossorigin="anonymous"></script>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Hero -->
    <header class="hero py-3 py-lg-6">
        <div class="container py-4">
            <div class="row align-items-center gy-4">
                <div class="col-lg-7">
                    <h1 class="display-5 fw-semibold">{{ aycommittee.committee.name }} {% if
                        aycommittee.committee.short_name %}({{aycommittee.committee.short_name}}){% endif %}
                        <br />{{aycommittee.academic_year.year}}<br />
                    </h1>
                    {% if aycommittee.committee.description %}<p class="lead mt-3">{{aycommittee.committee.description}}
                    </p>{% endif %}

                    <div class="d-flex gap-2 mt-2">
                        <nav class="mt-3">
                            <div class="btn-group" id="nav-tab" role="tablist">
                                <button class="btn btn-primary active" id="nav-members-tab" data-bs-toggle="tab"
                                    data-bs-target="#nav-members" type="button" role="tab" aria-controls="nav-members"
                                    aria-selected="true">Members</button>
                                <button class="btn btn-primary" id="nav-basic-tab" data-bs-toggle="tab"
                                    data-bs-target="#nav-basic" type="button" role="tab" aria-controls="nav-basic"
                                    aria-selected="true">Commitment Hours</button>
                                <button class="btn btn-primary" id="nav-meetings-tab" data-bs-toggle="tab"
                                    data-bs-target="#nav-meetings" type="button" role="tab" aria-controls="nav-meetings"
                                    aria-selected="false">Attendance</button>
                                <button class="btn btn-primary" id="nav-files-tab" data-bs-toggle="tab"
                                    data-bs-target="#nav-files" type="button" role="tab" aria-controls="nav-files"
                                    aria-selected="false">Documents</button>
                            </div>
                        </nav>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="card section-card">
                        <div class="card-body p-4">
                            <h5>Mission Statement</h5>
                            <div class="g-3 mt-1">
                                {{ aycommittee.committee.mission }}
                            </div>
                            <div class="g-3 mt-1">
                                <div class="row">
                                    <div class="col fw-bold">Committee Type:</div>
                                    <div class="col"> {{ aycommittee.committee.committee_type.type }}</div>
                                </div>
                                <div class="row">
                                    <div class="col fw-bold">Reporting Start:</div>
                                    <div class="col"> {{ aycommittee.committee.reporting_start_month_name }}</div>
                                </div>
                            </div>
                            {% if aycommittee.committee.description %}
                            <h5>Description</h5>
                            <div class="g-3 mt-1">
                                {{ aycommittee.committee.description }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
</div>
<div class="container">
    <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active" id="nav-members" role="tabpanel" aria-labelledby="nav-members-tab">
            <section id="members" class="py-5">
                <div class="card section-card">
                    <div class="card-body p-4 p-lg-5">
                        <!-- Members -->
                        <h3>Members</h3>
                        <div id="member-status" class="mt-3" role="alert"></div>
                        <!-- <label class="text-muted fst-italic">
                            <input type="checkbox" id="toggleActive"> Show "Deleted" Members
                        </label> -->
                        <table class="table table-striped table-sm table-responsive" id="memberTable"
                            data-order='[[ 0, "asc" ]]'>
                            <thead>
                                <tr>
                                    <th>Members</th>
                                    <th>Role</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Voting</th>
                                    <th>Committee Editor</th>
                                    {% if can_edit_committee(aycommittee.id, "edit") %}
                                    <th>Manage</th>
                                    {% endif %}
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="members-list">
                                {% for member in aycommittee.members %}
                                <tr data-id="{{ member.id }}">
                                    <td class="employee-id {% if member.deleted %}text-muted fst-italic{% endif %}"
                                        data-employee-id="{{ member.employee_id }}">{{ member.employee.employee_name }}
                                    </td>
                                    <td class="member-role {% if member.deleted %}text-muted fst-italic{% endif %}"
                                        data-member-role-id="{{ member.member_role_id }}">{{ member.member_role.role }}
                                    </td>
                                    <td class="start-date {% if member.deleted %}text-muted fst-italic{% endif %}">{{
                                        member.start_date.strftime('%Y-%m-%d') if member.start_date else '' }}</td>
                                    <td class="end-date {% if member.deleted %}text-muted fst-italic{% endif %}">{{
                                        member.end_date.strftime('%Y-%m-%d') if member.end_date else '' }}</td>
                                    <td class="voting {% if member.deleted %}text-muted fst-italic{% endif %}">
                                        {% if member.voting %}Yes{% else %}No{% endif %}
                                    </td>
                                    <td class="allow_edit {% if member.deleted %}text-muted fst-italic{% endif %}">
                                        {% if member.allow_edit %}Yes{% else %}No{% endif %}
                                    </td>
                                    {% if can_edit_committee(aycommittee.id, "edit") %}
                                    <td class="actions {% if member.deleted %}text-muted fst-italic{% endif %}">
                                        {% if not member.deleted %}
                                        <button class="btn btn-warning btn-sm edit-btn" data-bs-toggle="modal"
                                            data-bs-target="#memberModal" data-id="{{ member.id }}">Edit</button>
                                        <button class="btn btn-danger btn-sm delete-btn" data-bs-toggle="modal"
                                            data-bs-target="#deleteMemberModal"
                                            data-id="{{ member.id }}">Delete</button>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                    <td class="notes {% if member.deleted %}text-muted fst-italic{% endif %}">
                                        {% if member.deleted %}
                                        Deleted: {{ member.delete_date.strftime('%Y-%m-%d') }} ({{ member.notes }})
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% if can_edit_committee(aycommittee.id, "edit") %}
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#memberModal" id="addMemberButton">
                            Add Member
                        </button>
                        {% endif %}
                        <!-- Add/Edit Member Modal -->
                        <div class="modal fade" id="memberModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="memberModalTitle">Add Member</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Feedback message area -->
                                        <div id="addformResponseMessage" class="mt-3" role="alert"></div>
                                        <form id="memberForm">
                                            {{ memberForm.hidden_tag() }}
                                            <input type="hidden" id="member-id" name="member_id">

                                            <!-- Hidden field to determine Add/Edit -->
                                            {{ render_field(memberForm.employee_id, class="form-control mb-2") }}
                                            {{ render_field(memberForm.member_role_id, class="form-control mb-2") }}
                                            {{ render_field(memberForm.start_date, class="form-control mb-2") }}
                                            {{ render_field(memberForm.end_date, class="form-control mb-2") }}
                                            <label for="voting">{{ render_field(memberForm.voting) }}</label><br/>
                                            <label for="allow_edit">{{ render_field(memberForm.allow_edit) }}</label>
                                            {{ render_field(memberForm.notes, class="form-control mb-2") }}

                                            <button type="submit" class="btn btn-primary" id="memberFormSubmitBtn">Add
                                                Member</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delete Member Modal -->
                        <div class="modal fade" id="deleteMemberModal" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Delete Member <span id="deleteMember"></span></h5>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Feedback message area -->
                                        <div id="deleteFormResponseMessage" class="mt-3" role="alert"></div>
                                        <form id="deleteMemberForm">
                                            <input type="hidden" id="delete-member-id">
                                            {{ memberForm.hidden_tag() }}
                                            {{ render_field(memberForm.notes, class="form-control mb-2",
                                            required="required") }}
                                            <button type="submit" class="btn btn-danger">Yes, delete!</button>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No,
                                                cancel</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div> 

        <div class="tab-pane fade" id="nav-basic" role="tabpanel" aria-labelledby="nav-basic-tab">
            <section id="basic" class="py-5">
                <div class="card section-card">
                    <div class="card-body p-4 p-lg-5">
                        <!-- Commitment -->
                        <h3>Commitment Hours</h3>
                        <div id="commitmentMessage" class="mt-3"></div>
                        {% if can_edit_committee(aycommittee.id, "edit") %}
                        <form id="commitmentForm" method="POST"
                            action="{{ url_for('committee.save_commitment', ay_committee_id=aycommittee.id) }}">
                            {{ aycommitteeForm.hidden_tag() }}
                            {{ aycommitteeForm.academic_year_id(hidden=true) }}
                            {{ aycommitteeForm.committee_id(hidden=true) }}
                            {{ render_field(aycommitteeForm.meeting_frequency_type_id) }}
                            {{ render_field(aycommitteeForm.meeting_duration_in_minutes) }}
                            {{ render_field(aycommitteeForm.supplemental_minutes_per_frequency) }}
                            <button class="btn btn-primary" type="submit">Save</button>
                        </form>
                        {% else %}
                        <ul class="list-group">
                            <li class="list-group-item">
                                <strong>Meeting Frequency:</strong>
                                {{ aycommittee.meeting_frequency_type.type if aycommittee.meeting_frequency_type else 'N/A'
                                }}  
                            </li>
                            <li class="list-group-item">
                                <strong>Meeting Duration:</strong>
                                {{ aycommittee.meeting_duration_in_minutes if aycommittee.meeting_duration_in_minutes
                                else 'N/A' }} minutes
                            </li>
                            <li class="list-group-item">
                                <strong>Supplemental Minutes per Frequency:</strong>
                                {{ aycommittee.supplemental_minutes_per_frequency if
                                aycommittee.supplemental_minutes_per_frequency else 'N/A' }} minutes
                            </li>
                        </ul>
                        {% endif %}
                    </div>
                </div>
            </section>
        </div>

        <div class="tab-pane fade" id="nav-meetings" role="tabpanel" aria-labelledby="nav-meetings-tab">
            <section id="meetings" class="py-5">
                <div class="card section-card">
                    <div class="card-body p-4 p-lg-5">
                        <!-- Meetings -->
                        <h3>Meetings/Attendance</h3>
                        <div id="meeting-status" class="mt-3" role="alert"></div>
                        <table class="table table-striped table-sm table-responsive" id="meetingsTable"
                            data-ay-committee-id="{{ aycommittee.id }}"
                            data-can-edit="{{ 'true' if can_edit_committee(aycommittee.id) else 'false' }}">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Date/Time</th>
                                    <th>Location</th>
                                    <th>Notes</th>
                                    <th>Attendance</th>
                                    <!-- {% if can_edit_committee(aycommittee.id) %} -->
                                    <th>Manage</th>
                                    <!-- {% endif %} -->
                                </tr>
                            </thead>
                            <tbody></tbody>

                        </table>
                        {% if can_edit_committee(aycommittee.id, "edit") %}
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#meetingModal" id="addMeetingButton">
                            Add Meeting
                        </button>
                        {% endif %}
                    </div>
                </div>
            </section>
        </div>

        <!-- Add/Edit Meeting Modal -->
        <div class="modal fade" id="meetingModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="meetingModalTitle">Add Meeting</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="meetingForm">
                            {{ meetingForm.hidden_tag() }}
                            <input type="hidden" id="meeting-id" name="meeting_id">

                            <!-- Meeting Title -->
                            {{ render_field(meetingForm.title, class="form-control mb-2") }}

                            <!-- Meeting Date -->
                            {{ render_field(meetingForm.date, class="form-control mb-2") }}

                            <!-- Location -->
                            {{ render_field(meetingForm.location, class="form-control mb-2") }}

                            <!-- Notes -->
                            {{ render_field(meetingForm.notes, class="form-control mb-2") }}

                            <!-- Submit Button -->
                            <button type="submit" class="btn btn-primary" id="meetingFormSubmitBtn">Save
                                Meeting</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Modal -->
        <div class="modal fade" id="attendanceModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="attendanceForm">

                        <div class="modal-header">
                            <h5 class="modal-title">Attendance - {{ aycommittee.committee.name
                                }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>

                        <div class="modal-body">
                            
                            <input type="hidden" name="ay_committee_id" id="attendanceCommitteeId">
                            <input type="hidden" name="meeting_id" id="attendanceMeetingId">
                            <table class="table table-sm table-responsive">
                                <thead>
                                    <tr>
                                        <th>Member</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceModalBody">
                                    <!-- Member rows will be injected here -->
                                </tbody>
                            </table>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save
                                Attendance</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="nav-files" role="tabpanel" aria-labelledby="nav-files-tab">
            <section id="documents" class="py-5">
                <div class="card section-card">
                    <div class="card-body p-4 p-lg-5">
                        <!-- Documents -->
                        <h3>Documents</h3>
                        <div id="upload-status" class="mt-3" role="alert"></div>
                        <!-- <p id="upload-status"></p> -->
                        <table id="files-table" class="display table-sm table-responsive"
                            data-ay-committee-id="{{ aycommittee.id }}"
                            data-can-edit="{{ 'true' if can_edit_committee(aycommittee.id) else 'false' }}">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Size</th>
                                    <th>Preview</th>
                                    <th>Manage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filled dynamically -->
                            </tbody>
                        </table>
                        {% if can_edit_committee(aycommittee.id, "edit") %}
                        <h3>Upload Documents</h3>
                        <form id="upload-form" enctype="multipart/form-data">
                            {{ uploadForm.hidden_tag() }}
                            <div id="drop-area">Drop files here</div>

                            <input type="file" id="file-input"
                                accept=".pdf,.doc,.docx,.xls,.xlsx,.pages,.numbers,.key,.ppt,.pptx,.jpg,.jpeg,.png,.gif,.bmp,.svg,.webp"
                                multiple>

                            <button type="button" id="browse-btn" class="btn btn-secondary">Browse</button>

                            <button type="submit" id="save-btn" class="btn btn-primary" disabled>Save Files</button>
                        </form>

                        <div id="file-list"></div>
                        {% endif %}
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>
<!-- End Main content -->
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='scripts/committee-members.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='scripts/committee-files.js') }}" type="text/javascript"></script>
<script src="{{ url_for('static', filename='scripts/committee-meetings.js') }}" type="text/javascript"></script>
{% endblock %}