{% extends 'base.html' %}

{% block head %}
{{super()}}

<!-- DataTables CSS -->
<!-- <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css"> -->

<!-- jQuery (required by DataTables) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables JS -->
<!-- <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script> -->
<!-- DataTables CSS -->
<link
    href="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.css"
    rel="stylesheet" integrity="sha384-Ds1Vklai96R25BXbTa08O+OjpAevmakmGFQNAQECNryYdQ0qbN4CJSMwUSFT+NYe"
    crossorigin="anonymous">
    
<!-- DataTables JS -->
<script
    src="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.js"
    integrity="sha384-lGlyEraPH4ouPKo2ethY8Xic4JlIXN/CUbMNpOce3EjRhLuGH732aMGDH7Cv8+VY"
    crossorigin="anonymous"></script>


{% endblock %}

{% block content %}

<div class="container">
    <h2>All Students</h2>

    <form method="get" action="{{ url_for('students.list_students') }}" class="mb-3">
        <div class="form-group row align-items-center">
            <label for="class_of" class="col-sm-2 col-form-label">Filter by Class Of:</label>
            <div class="col-sm-2">
                <select name="class_of" id="class_of" onchange="this.form.submit()" class="form-select">
                    <option value="">-- All --</option>
                    {% for year in class_years %}
                    <option value="{{ year }}" {% if selected_class==year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-sm-2">
                {% if selected_class %}
                <a href="{{ url_for('students.list_students') }}">Clear Filter</a>
                {% endif %}
            </div>
        </div>
    </form>

    <form method="POST" action="{{ url_for('students.generate_photo_cards') }}">
        <input type="hidden" name="class_of" value="{{ selected_class or '' }}">
        <div class="mb-2 form-group row">
            <label for="pdf_title" class="col-sm-2 col-form-label">Header Title:</label>
            <div class="col-sm-4">
                <input type="text" id="pdf_title" name="pdf_title" class="form-control"
                    placeholder="e.g., SPPS 201 Fall 2025 Class Roster">
            </div>
        </div>
        <div class="mb-2 form-group row">
            <label for="pdf_filename" class="col-sm-2 col-form-label">Filename:</label>
            <div class="col-sm-4">
                <input type="text" id="pdf_filename" name="pdf_filename" class="form-control"
                    placeholder="e.g., spps_201_fa25">
            </div>
        </div>
        <button type="submit" class="btn btn-primary mb-2">Generate Photo Cards PDF</button>

        <table class="table table-striped table-bordered">
            <tr>
                <th><input type="checkbox" id="check-all" /></th>
                <th>Photo</th>
                <th>Name</th>
                <th>PID</th>
                <th>Class</th>
                <th>Email</th>
                {% if has_permission('students+add') or has_permission('students+edit') or
                has_permission('students+delete')
                %}
                <th>Actions</th>
                {% endif %}
            </tr>
            {% for s in students %}
            <tr>
                <td><input type="checkbox" name="student_ids" value="{{ s.id }}" /></td>
                <td>
                    {% if s.photo_url %}
                    <img src="{{ url_for('static', filename='photos/' ~ s.photo_url) }}" width="60"
                        class="rounded-circle">
                    {% endif %}
                </td>
                <td>{{ s.last_name }}, {{ s.first_name }}
                    {% if s.phonetic_last_name or s.phonetic_first_name %}<br />
                    <span class="fst-italic fw-light">{{ s.phonetic_last_name }}, {{ s.phonetic_first_name }}</span>
                    {% endif %}
                    {% if s.pronoun %}<span class="fw-light"><br />{{ s.pronoun }}</span>{% endif %}
                </td>
                <td>{{ s.pid }}</td>
                <td>{{ s.class_of }}</td>
                <td><a href="mailto:{{ s.email }}">{{ s.email }}</a></td>
                {% if has_permission('students+add') or has_permission('students+edit') or
                has_permission('students+delete')
                %}
                <td>
                    {% if has_permission('students+add') or has_permission('students+edit') %}
                    <a href="{{ url_for('students.edit_student', student_id=s.id) }}"
                        class="btn btn-sm btn-primary">Edit</a>
                    {% endif %}
                    {% if has_permission('students+delete') %}
                    <button type="button" class="btn btn-sm btn-danger" 
                        onclick="submitDeleteForm('{{ url_for("students.delete_student", student_id=s.id) }}')">
                        Delete
                    </button>
                    {% endif %}
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </table>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.getElementById("check-all").addEventListener("change", function () {
        const checkboxes = document.querySelectorAll("input[name='student_ids']");
        for (const box of checkboxes) {
            box.checked = this.checked;
        }
    });

    function submitDeleteForm(actionUrl) {
        if (confirm("Are you sure you want to delete this student?")) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = actionUrl;
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}