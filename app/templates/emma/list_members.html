{% extends "base.html" %}
{% block head %}
{{super()}}
<!-- DataTables CSS -->
<link
    href="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.css"
    rel="stylesheet" integrity="sha384-Ds1Vklai96R25BXbTa08O+OjpAevmakmGFQNAQECNryYdQ0qbN4CJSMwUSFT+NYe"
    crossorigin="anonymous">

<!-- DataTables JS -->
<script
    src="https://cdn.datatables.net/v/dt/jszip-3.10.1/dt-2.2.2/af-2.7.0/b-3.2.2/b-colvis-3.2.2/b-html5-3.2.2/b-print-3.2.2/cr-2.0.4/date-1.5.5/fc-5.0.4/fh-4.0.1/kt-2.12.1/r-3.0.4/rg-1.5.1/rr-1.5.0/sc-2.4.3/sb-1.8.2/sp-2.3.3/sl-3.0.0/sr-1.4.1/datatables.min.js"
    integrity="sha384-lGlyEraPH4ouPKo2ethY8Xic4JlIXN/CUbMNpOce3EjRhLuGH732aMGDH7Cv8+VY"
    crossorigin="anonymous"></script>
{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Members for Group: {{ group.group_name }}</h2>
    <a href="{{ url_for('emma.groups_page') }}" class="btn btn-secondary btn-sm mb-3">‚Üê Back to MyEmma Groups</a>

    <!-- Spinner -->
    <div id="loading" class="text-center my-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading members, please wait...</p>
    </div>

    <!-- Tabs and table container -->
    <div id="members-content" class="d-none">
        <div class="d-flex justify-content-between align-items-center">
            <!-- <h5 class="mb-0">Members</h5> -->
            <div>
                <label for="statusFilter" class="me-2 fw-bold">Filter by Status:</label>
                <select id="statusFilter" class="form-select form-select-sm d-inline-block" style="width: 200px;">
                    <option value="">All</option>
                    <!-- <option value="active">Active</option>
                    <option value="error">Error</option>
                    <option value="opt-out">Opt-Out</option> -->
                </select>
            </div>
        </div>

        <table id="members-table" class="table table-bordered table-striped w-100">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Email</th>
                    <th>Name</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <!-- <ul class="nav nav-tabs" id="memberTabs" role="tablist">
            <li class="nav-item"><button class="nav-link active" id="active-tab" data-bs-toggle="tab"
                    data-bs-target="#active" type="button">Active</button></li>
            <li class="nav-item"><button class="nav-link" id="error-tab" data-bs-toggle="tab" data-bs-target="#error"
                    type="button">Error</button></li>
            <li class="nav-item"><button class="nav-link" id="optout-tab" data-bs-toggle="tab" data-bs-target="#optout"
                    type="button">Opt-Out</button></li>
        </ul> -->

        <!-- <div class="tab-content mt-3">
            <div class="tab-pane fade show active" id="active" role="tabpanel"></div>
            <div class="tab-pane fade" id="error" role="tabpanel"></div>
            <div class="tab-pane fade" id="optout" role="tabpanel"></div>
        </div> -->
    </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const groupId = {{ group.member_group_id }};
        const groupName = `{{ group.group_name }}`;
        const apiUrl = `/emma/api/groups/${groupId}/members`;

        fetch(apiUrl)
            .then(r => r.json())
            .then(data => {
                // Hide spinner, show content
            document.querySelector("#loading").classList.add("d-none");
            document.querySelector("#members-content").classList.remove("d-none");

            // Count members per status
            const counts = data.reduce((acc, m) => {
                const s = m.status || '(no status)';
                acc[s] = (acc[s] || 0) + 1;
                return acc;
            }, {});
            const total = data.length;

            // Populate dropdown filter
            const statusFilter = document.querySelector('#statusFilter');
            const statuses = Object.keys(counts).sort();
            statusFilter.innerHTML = `
                <option value="">All (${total})</option>
                ${statuses.map(s => `<option value="${s}">${s.charAt(0).toUpperCase() + s.slice(1)} (${counts[s]})</option>`).join('')}
            `;

            // Populate table
            const tbody = document.querySelector("#members-table tbody");
            tbody.innerHTML = data.map((m, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${m.email || '(no email)'}</td>
                    <td>${(m.fields?.first_name || '')} ${(m.fields?.last_name || '')}</td>
                    <td>${m.status || '(no status)'}</td>
                </tr>
            `).join('');
            
            // Initialize DataTable
            const table = $('#members-table').DataTable({
                pageLength: 25,
                lengthMenu: [10, 25, 50, 100],
                order: [[1, 'asc']], // sort by email
                layout: {
                    topStart: {
                        buttons: [
                            'pageLength',
                            {
                                extend: 'csv',
                                exportOptions: { columns: ':visible' },
                                title: `${groupName} Members`
                            },
                            {
                                extend: 'excel',
                                exportOptions: { columns: ':visible' },
                                title: `${groupName} Members`
                            },
                            {
                                extend: 'print',
                                exportOptions: { columns: ':visible' },
                                orientation: 'portrait',
                                pageSize: 'LEGAL',
                                title: `${groupName} Members`
                            }
                        ]
                    }
                }
            });

            // Status Filter functionality
            statusFilter.addEventListener('change', () => {
                const val = statusFilter.value;
                table.column(3).search(val ? `^${val}$` : '', true, false).draw();
            });

        })
        .catch(err => {
            document.querySelector("#loading").innerHTML = `<p class="text-danger">Failed to load members.</p>`;
            console.error(err);
        });
            // document.querySelector("#active").innerHTML = renderTable(active, 'active-table');
            // document.querySelector("#error").innerHTML = renderTable(error, 'error-table');
            // document.querySelector("#optout").innerHTML = renderTable(optout, 'optout-table');

            // // Hide spinner, show content
            // document.querySelector("#loading").classList.add("d-none");
            // document.querySelector("#members-content").classList.remove("d-none");

            // Initialize DataTables for all 3 tables
            // ['active-table', 'error-table', 'optout-table'].forEach(id => {
            //     $(`#${id}`).DataTable({
            //         pageLength: 25,
            //         lengthMenu: [10, 25, 50, 100],
            //         order: [[1, 'asc']], // default sort by Email
            //         layout: {
            //             topStart: {
            //                 buttons: [
            //                     'pageLength',
            //                     {
            //                         extend: 'csv',
            //                         exportOptions: {
            //                             columns: ':visible',
            //                             format: {
            //                                 body: function (data, column, row) {
            //                                     return data ? data.replace(/<br\s*\/?>/ig, "\r\n") : data; //change <br/> to \r\n line feed
            //                                 }
            //                             }
            //                         },
            //                         title: `${groupName} Members`
            //                     },
            //                     {
            //                         extend: 'excel',
            //                         exportOptions: {
            //                             columns: ':visible',
            //                             format: {
            //                                 body: function (data, column, row) {
            //                                     return data ? data.replace(/<br\s*\/?>/ig, "\r\n") : data; //change <br/> to \r\n line feed
            //                                 }
            //                             }
            //                         },
            //                         title: `${groupName} Members`
            //                     },
            //                     {
            //                         extend: 'print',
            //                         exportOptions: {
            //                             columns: ':visible',
            //                             format: {
            //                                 body: function (data, column, row) {
            //                                     return data ? data.replace(/<br\s*\/?>/ig, "\r\n") : data; //change <br/> to \r\n line feed
            //                                 }
            //                             }
            //                         },
            //                         orientation: 'portrait',
            //                         pageSize: 'LEGAL',
            //                         title: `${groupName} Members`
            //                     }
            //                 ]
            //             }
            //         }
            //         // dom: 'Bfrtip',
            //         // buttons: [
            //         //     {
            //         //         extend: 'excelHtml5',
            //         //         text: 'Export to Excel',
            //         //         titleAttr: 'Export to Excel'
            //         //     }
            //         // ]
            //     });
            // });

        // })
        // .catch(err => {
        //     document.querySelector("#loading").innerHTML = `<p class="text-danger">Failed to load members.</p>`;
        //     console.log(err);
        // });
    });
</script>
{% endblock %}